@page "/Account/ExternalLogin"
@attribute [AllowAnonymous]
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims
@using Microsoft.AspNetCore.Identity
@using ScioBlazor.Data

@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject IdentityRedirectManager RedirectManager
@inject ILogger<ExternalLogin> Logger
@inject ScioBlazor.Services.INameDeclensionService NameDeclension

@code {
    public const string LoginCallbackAction = "LoginCallback";

    [SupplyParameterFromQuery]
    private string? Action { get; set; }

    [SupplyParameterFromQuery]
    private string? ReturnUrl { get; set; }

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        if (HttpMethods.IsGet(HttpContext.Request.Method) && Action == LoginCallbackAction)
        {
            await OnGetCallbackAsync();
        }
    }

    private async Task OnGetCallbackAsync()
    {
        var info = await SignInManager.GetExternalLoginInfoAsync();
        if (info is null)
        {
            RedirectManager.RedirectToWithStatus("/Account/Login", "Error loading external login information.", HttpContext);
        }

        // Try sign-in with existing external login
        var result = await SignInManager.ExternalLoginSignInAsync(info.LoginProvider, info.ProviderKey, isPersistent: false, bypassTwoFactor: true);
        if (result.Succeeded)
        {
            Logger.LogInformation("User logged in with {LoginProvider} provider.", info.LoginProvider);
            RedirectManager.RedirectTo(ReturnUrl);
        }
        if (result.IsLockedOut)
        {
            RedirectManager.RedirectTo("/Account/Lockout");
        }
        if (result.RequiresTwoFactor)
        {
            RedirectManager.RedirectTo("/Account/LoginWith2fa", new() { ["returnUrl"] = ReturnUrl, ["rememberMe"] = false });
        }

        // No account yet: auto-provision a user for Google-only flow
        var email = info.Principal.FindFirstValue(ClaimTypes.Email);
        if (string.IsNullOrWhiteSpace(email))
        {
            RedirectManager.RedirectToWithStatus("/Account/Login", "Google sign-in did not provide an email.", HttpContext);
        }

        var user = await UserManager.FindByEmailAsync(email);
        if (user is null)
        {
            // Try to populate profile names from external claims
            var given = info.Principal.FindFirstValue(ClaimTypes.GivenName) ?? info.Principal.FindFirstValue("given_name");
            var family = info.Principal.FindFirstValue(ClaimTypes.Surname) ?? info.Principal.FindFirstValue("family_name");

            user = new ApplicationUser { UserName = email, Email = email, EmailConfirmed = true, FirstName = given, LastName = family };
            var createResult = await UserManager.CreateAsync(user);
            if (!createResult.Succeeded)
            {
                RedirectManager.RedirectToWithStatus("/Account/Login", $"Error creating user: {string.Join(", ", createResult.Errors.Select(e => e.Description))}", HttpContext);
            }

            // Try to fetch instrumental form for first name
            if (!string.IsNullOrWhiteSpace(user.FirstName))
            {
                var instr = await NameDeclension.GetInstrumentalFirstNameAsync(user.FirstName!);
                if (!string.IsNullOrWhiteSpace(instr))
                {
                    user.FirstNameInstrumental = instr;
                    try { await UserManager.UpdateAsync(user); } catch { /* ignore */ }
                }
            }
        }

        // Update missing names for existing user if available
        if (user is not null)
        {
            var upd = false;
            var given = info.Principal.FindFirstValue(ClaimTypes.GivenName) ?? info.Principal.FindFirstValue("given_name");
            var family = info.Principal.FindFirstValue(ClaimTypes.Surname) ?? info.Principal.FindFirstValue("family_name");
            if (string.IsNullOrWhiteSpace(user.FirstName) && !string.IsNullOrWhiteSpace(given)) { user.FirstName = given; upd = true; }
            if (string.IsNullOrWhiteSpace(user.LastName) && !string.IsNullOrWhiteSpace(family)) { user.LastName = family; upd = true; }
            if (upd)
            {
                await UserManager.UpdateAsync(user);
            }

            // If instrumental is missing, try to fetch it now
            if (string.IsNullOrWhiteSpace(user.FirstNameInstrumental) && !string.IsNullOrWhiteSpace(user.FirstName))
            {
                var instr = await NameDeclension.GetInstrumentalFirstNameAsync(user.FirstName!);
                if (!string.IsNullOrWhiteSpace(instr))
                {
                    user.FirstNameInstrumental = instr;
                    try { await UserManager.UpdateAsync(user); } catch { /* ignore */ }
                }
            }
        }

        var addLoginResult = await UserManager.AddLoginAsync(user, info);
        if (!addLoginResult.Succeeded)
        {
            // The login may already be associated; try sign-in regardless
            Logger.LogWarning("AddLogin failed for {LoginProvider}. Proceeding to sign-in.", info.LoginProvider);
        }

        await SignInManager.SignInAsync(user, isPersistent: false);
        RedirectManager.RedirectTo(ReturnUrl);
    }
}
